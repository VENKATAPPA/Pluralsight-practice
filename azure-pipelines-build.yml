trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  acrLoginServer: "pspracticeacr.azurecr.io"
  aksResourceGroup: "pspractice-rg"   # update if needed
  aksName: "pspractice-aks"
  imageTag: "$(Build.BuildId)"

stages:

# =====================
# 1. BUILD & PUSH IMAGES
# =====================
- stage: Build
  displayName: "Build & Push Images"
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - script: |
        echo ">>> LOGIN TO AZURE (DEVICE CODE)"
        az login --use-device-code

        echo ">>> LOGIN TO ACR"
        az acr login --name pspracticeacr

        echo ">>> BUILD API IMAGE"
        docker build -f docker/api.Dockerfile -t $(acrLoginServer)/ps-api:$(imageTag) .

        echo ">>> PUSH API IMAGE"
        docker push $(acrLoginServer)/ps-api:$(imageTag)

        echo ">>> BUILD WEB IMAGE"
        docker build -f docker/web.Dockerfile -t $(acrLoginServer)/ps-web:$(imageTag) .

        echo ">>> PUSH WEB IMAGE"
        docker push $(acrLoginServer)/ps-web:$(imageTag)
      displayName: "Build & Push to ACR"


# =====================
# 2. DEPLOY TO AKS
# =====================
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: Build
  jobs:
  - job: DeployJob
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - script: |
        echo ">>> LOGIN TO AZURE (DEVICE CODE)"
        az login --use-device-code

        echo ">>> GET AKS CREDENTIALS"
        az aks get-credentials \
          --resource-group $(aksResourceGroup) \
          --name $(aksName) \
          --overwrite-existing
        
        echo ">>> APPLY DEPLOYMENTS"
        kubectl apply -f k8s/api-deployment.yaml
        kubectl apply -f k8s/api-service.yaml
        kubectl apply -f k8s/web-deployment.yaml
        kubectl apply -f k8s/web-service.yaml

        echo ">>> UPDATE IMAGES"
        kubectl set image deployment/api-deployment \
          ps-api=$(acrLoginServer)/ps-api:$(imageTag)

        kubectl set image deployment/web-deployment \
          social-web=$(acrLoginServer)/ps-web:$(imageTag)

        echo ">>> SHOW SERVICES"
        kubectl get svc
      displayName: "Deploy to AKS"
